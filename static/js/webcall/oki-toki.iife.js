var _=Object.defineProperty;var y=(c,l,r)=>l in c?_(c,l,{enumerable:!0,configurable:!0,writable:!0,value:r}):c[l]=r;var s=(c,l,r)=>(y(c,typeof l!="symbol"?l+"":l,r),r);(function(){"use strict";const c='<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24"><path d="M19.95 21q-3.225 0-6.287-1.438-3.063-1.437-5.425-3.8-2.363-2.362-3.8-5.425Q3 7.275 3 4.05q0-.45.3-.75t.75-.3H8.1q.35 0 .625.225t.325.575l.65 3.5q.05.35-.012.637-.063.288-.288.513L7 10.9q1.05 1.8 2.625 3.375T13.1 17l2.35-2.35q.225-.225.588-.338.362-.112.712-.062l3.45.7q.35.075.575.337.225.263.225.613v4.05q0 .45-.3.75t-.75.3Z"/></svg>',l='<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24"><path d="M19 11.95q0-2.925-2.038-4.963Q14.925 4.95 12 4.95v-2q1.875 0 3.513.712 1.637.713 2.85 1.926 1.212 1.212 1.925 2.85Q21 10.075 21 11.95Zm-4 0q0-1.25-.875-2.125T12 8.95v-2q2.075 0 3.538 1.462Q17 9.875 17 11.95ZM19.95 21q-3.225 0-6.287-1.438-3.063-1.437-5.425-3.8-2.363-2.362-3.8-5.425Q3 7.275 3 4.05q0-.45.3-.75t.75-.3H8.1q.35 0 .625.225t.325.575l.65 3.5q.05.35-.012.637-.063.288-.288.513L7 10.9q1.05 1.8 2.625 3.375T13.1 17l2.35-2.35q.225-.225.588-.338.362-.112.712-.062l3.45.7q.35.075.575.337.225.263.225.613v4.05q0 .45-.3.75t-.75.3Z"/></svg>',r='<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24"><path d="m10.6 16.6 7.05-7.05-1.4-1.4-5.65 5.65-2.85-2.85-1.4 1.4ZM12 22q-2.075 0-3.9-.788-1.825-.787-3.175-2.137-1.35-1.35-2.137-3.175Q2 14.075 2 12t.788-3.9q.787-1.825 2.137-3.175 1.35-1.35 3.175-2.138Q9.925 2 12 2t3.9.787q1.825.788 3.175 2.138 1.35 1.35 2.137 3.175Q22 9.925 22 12t-.788 3.9q-.787 1.825-2.137 3.175-1.35 1.35-3.175 2.137Q14.075 22 12 22Z"/></svg>',p='<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24"><path d="M12 23q-.825 0-1.412-.587Q10 21.825 10 21q0-.825.588-1.413Q11.175 19 12 19t1.413.587Q14 20.175 14 21q0 .825-.587 1.413Q12.825 23 12 23ZM6 5q-.825 0-1.412-.588Q4 3.825 4 3t.588-1.413Q5.175 1 6 1t1.412.587Q8 2.175 8 3q0 .825-.588 1.412Q6.825 5 6 5Zm0 6q-.825 0-1.412-.588Q4 9.825 4 9t.588-1.413Q5.175 7 6 7t1.412.587Q8 8.175 8 9q0 .825-.588 1.412Q6.825 11 6 11Zm0 6q-.825 0-1.412-.587Q4 15.825 4 15q0-.825.588-1.413Q5.175 13 6 13t1.412.587Q8 14.175 8 15q0 .825-.588 1.413Q6.825 17 6 17ZM18 5q-.825 0-1.413-.588Q16 3.825 16 3t.587-1.413Q17.175 1 18 1q.825 0 1.413.587Q20 2.175 20 3q0 .825-.587 1.412Q18.825 5 18 5Zm-6 12q-.825 0-1.412-.587Q10 15.825 10 15q0-.825.588-1.413Q11.175 13 12 13t1.413.587Q14 14.175 14 15q0 .825-.587 1.413Q12.825 17 12 17Zm6 0q-.825 0-1.413-.587Q16 15.825 16 15q0-.825.587-1.413Q17.175 13 18 13q.825 0 1.413.587Q20 14.175 20 15q0 .825-.587 1.413Q18.825 17 18 17Zm0-6q-.825 0-1.413-.588Q16 9.825 16 9t.587-1.413Q17.175 7 18 7q.825 0 1.413.587Q20 8.175 20 9q0 .825-.587 1.412Q18.825 11 18 11Zm-6 0q-.825 0-1.412-.588Q10 9.825 10 9t.588-1.413Q11.175 7 12 7t1.413.587Q14 8.175 14 9q0 .825-.587 1.412Q12.825 11 12 11Zm0-6q-.825 0-1.412-.588Q10 3.825 10 3t.588-1.413Q11.175 1 12 1t1.413.587Q14 2.175 14 3q0 .825-.587 1.412Q12.825 5 12 5Z"/></svg>',b='<svg><path d="M19 11.95q0-2.925-2.038-4.963Q14.925 4.95 12 4.95v-2q1.875 0 3.513.712 1.637.713 2.85 1.926 1.212 1.212 1.925 2.85Q21 10.075 21 11.95Zm-4 0q0-1.25-.875-2.125T12 8.95v-2q2.075 0 3.538 1.462Q17 9.875 17 11.95ZM19.95 21q-3.225 0-6.287-1.438-3.063-1.437-5.425-3.8-2.363-2.362-3.8-5.425Q3 7.275 3 4.05q0-.45.3-.75t.75-.3H8.1q.35 0 .625.225t.325.575l.65 3.5q.05.35-.012.637-.063.288-.288.513L7 10.9q1.05 1.8 2.625 3.375T13.1 17l2.35-2.35q.225-.225.588-.338.362-.112.712-.062l3.45.7q.35.075.575.337.225.263.225.613v4.05q0 .45-.3.75t-.75.3Z"/></svg>',f='<svg xmlns="http://www.w3.org/2000/svg" height="24" width="24"><path d="M12 8q2.95 0 5.812 1.188 2.863 1.187 5.088 3.562.3.3.3.7 0 .4-.3.7l-2.3 2.25q-.275.275-.637.3-.363.025-.663-.2l-2.9-2.2q-.2-.15-.3-.35-.1-.2-.1-.45v-2.85q-.95-.3-1.95-.475T12 10q-1.05 0-2.05.175-1 .175-1.95.475v2.85q0 .25-.1.45t-.3.35l-2.9 2.2q-.3.225-.662.2-.363-.025-.638-.3l-2.3-2.25q-.3-.3-.3-.7 0-.4.3-.7 2.2-2.375 5.075-3.562Q9.05 8 12 8Z"/></svg>',u={en:{call:"Call us",calling:"Calling...",end:"Call ended",unsupported:"Your browser does not support WebRTC"},ru:{call:"\u041F\u043E\u0437\u0432\u043E\u043D\u0438\u0442\u044C \u043D\u0430\u043C",calling:"\u0421\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435...",end:"\u0420\u0430\u0437\u0433\u043E\u0432\u043E\u0440 \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043D",unsupported:"\u0412\u0430\u0448 \u0431\u0440\u0430\u0443\u0437\u0435\u0440 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442 WebRTC"}};var d=(n=>(n.Static="static",n.Floating="floating",n))(d||{});const m=`.oki-web-call{position:relative;user-select:none;display:inline-flex;align-items:center;padding:0 24px;font-family:var(--web-call-font-family);font-weight:var(--web-call-font-weight);font-size:var(--web-call-font-size);border-radius:var(--web-call-border-radius);cursor:pointer;transition:all .15s ease-out}.oki-web-call--type-floating{position:fixed;bottom:24px;right:24px;z-index:99999;box-shadow:-8px 8px 12px #00000026}.oki-web-call--type-floating .oki-web-call__text{display:none}.oki-web-call--type-floating .oki-web-call__keyboard-toggle{position:absolute;bottom:100%;left:50%;width:100%;height:100%;border-radius:50%;margin:0;transform:translate(-50%,-12px);background-color:var(--web-call-talking);color:var(--web-call-talking-text);transition:all .15s ease-out;box-shadow:-8px 8px 12px #00000026}.oki-web-call--type-floating .oki-web-call__keyboard-toggle:hover{background-color:var(--web-call-talking-hover)}.oki-web-call--type-floating .oki-web-call__icon{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);margin:0}@keyframes oki-web-call-show{0%{opacity:0}to{opacity:100%}}@keyframes oki-web-call-keyboard{0%{opacity:0;transform:translate(-50%)}to{opacity:100%;transform:translate(-50%,-16px)}}@keyframes oki-web-call-floating-keyboard{0%{opacity:0;transform:translate(0)}to{opacity:100%;transform:translate(-16px)}}.oki-web-call svg{fill:currentColor}.oki-web-call__stage{display:none;align-items:center;animation:oki-web-call-show .15s ease-out}.oki-web-call__keyboard-toggle{display:flex;align-items:center;justify-content:center;width:24px;min-width:24px;height:24px;border-radius:50%;margin-left:8px;margin-right:-8px}.oki-web-call__keyboard{position:absolute;display:none;bottom:100%;left:50%;transform:translate(-50%,-16px);padding:8px;border-radius:12px;box-shadow:0 8px 16px #00000026;animation:oki-web-call-keyboard .3s ease-out;background-color:var(--web-call-talking);color:var(--web-call-talking-text)}.oki-web-call--type-floating .oki-web-call__keyboard{right:100%;bottom:0;left:auto;transform:translate(-16px);animation:oki-web-call-floating-keyboard .3s ease-out}.oki-web-call--show-keyboard .oki-web-call__keyboard{display:block}.oki-web-call__keyboard:after{content:"";position:absolute;bottom:0;left:50%;transform:translate(-50%,50%) rotate(45deg);width:12px;height:12px;background-color:var(--web-call-talking)}.oki-web-call--type-floating .oki-web-call__keyboard:after{bottom:16px;left:100%;transform:translate(-50%) rotate(45deg)}.oki-web-call__keyboard-row{display:flex;flex-wrap:wrap;justify-content:center;width:120px}.oki-web-call__keyboard-col{flex-basis:calc(100% / 3);max-width:calc(100% / 3);min-width:calc(100% / 3);display:flex;align-items:center;justify-content:center}.oki-web-call__keyboard-button{width:40px;height:40px;display:flex;align-items:center;justify-content:center;transition:all .15s ease-out;border-radius:50%;background-color:var(--web-call-talking)}.oki-web-call__keyboard-button:hover{background-color:var(--web-call-talking-text);color:var(--web-call-talking)}.oki-web-call__keyboard-button:active{transform:scale(.8)}.oki-web-call__icon{display:flex;align-items:center;justify-content:center;width:24px;min-width:24px;height:24px;margin-right:4px;margin-left:-8px}.oki-web-call__icon--talking{margin-right:8px;margin-top:-2px}.oki-web-call__text{margin-top:-2px}.oki-web-call--stage-call .oki-web-call__stage--call{display:flex}.oki-web-call--stage-call{background-color:var(--web-call-call);color:var(--web-call-call-text)}.oki-web-call--stage-call:hover{background-color:var(--web-call-call-hover)}.oki-web-call--stage-calling{background-color:var(--web-call-calling);color:var(--web-call-calling-text)}.oki-web-call--stage-calling:hover{background-color:var(--web-call-calling-hover)}.oki-web-call--stage-calling .oki-web-call__stage--calling{display:flex}.oki-web-call--stage-talking{background-color:var(--web-call-talking);color:var(--web-call-talking-text)}.oki-web-call--stage-talking:hover{background-color:var(--web-call-talking-hover)}.oki-web-call--stage-talking .oki-web-call__stage--talking{display:flex}.oki-web-call--stage-end{background-color:var(--web-call-end);color:var(--web-call-end-text)}.oki-web-call--stage-end:hover{background-color:var(--web-call-end-hover)}.oki-web-call--stage-end .oki-web-call__stage--end{display:flex}
`,w=Object.assign({"./icons/call.svg":c,"./icons/calling.svg":l,"./icons/end.svg":r,"./icons/keyboard.svg":p,"./icons/phone.svg":b,"./icons/talking.svg":f});function h(n){return w[`./icons/${n}.svg`]}class v{constructor(t){s(this,"target");s(this,"className");s(this,"timer",0);s(this,"permissions",!1);s(this,"stage");s(this,"stageList");s(this,"stages",[]);s(this,"options");s(this,"cssVars");s(this,"stylesElement");s(this,"audioPlayer");s(this,"server");s(this,"login");s(this,"dnis");s(this,"isConnected");s(this,"isSupported");s(this,"isPermitted");s(this,"peerConnection");s(this,"sessionDescription");s(this,"ws");s(this,"sessionId");s(this,"ice");s(this,"stopIce");s(this,"pc");s(this,"busy");s(this,"localStream");s(this,"mozOffer");s(this,"offerConstraints");s(this,"clickListener");this.server=t.server,this.login=t.login,this.dnis=t.dnis,this.isConnected=!1,this.isSupported=!1,this.isPermitted=!1,this.peerConnection=null,this.sessionDescription=null,this.ws=null,this.sessionId=0,this.ice={iceServers:[]},this.stopIce=0,this.pc=null,this.busy=0,this.localStream=null,this.mozOffer=null,this.clickListener=null,this.offerConstraints={optional:[{OfferToReceiveAudio:!0},{OfferToReceiveVideo:!1},{DtlsSrtpKeyAgreement:!0}]},this.stylesElement=null,this.audioPlayer=null,this.stage="call",this.stageList=["call","calling","talking","end"],this.cssVars={"border-radius":"24px","font-family":t.font||"sans-serif","font-weight":t.fontWeight||600};let e={call:"#ffa726","call-hover":"#ff9800","call-text":"#fff",calling:"#ffca28","calling-hover":"#ffb300","calling-text":"#fff",talking:"#42a5f5","talking-hover":"#2196f3","talking-text":"#fff",end:"#9ccc65","end-hover":"#7cb342","end-text":"#fff"};const i={availableLangs:["en","ru"],lang:"en",messages:u.en,showMessages:!0,buttonType:d.Static,buttonWidth:48,buttonHeight:48,className:"oki-web-call"};if(!t.hasOwnProperty("target")||!t.target)throw new Error('OkiToki "target" is required parameter');let a=null;if(typeof t.target=="string"?a=document.querySelector(t.target):typeof t.target=="object"&&(a=t.target),!a)throw new Error(`OkiToki: Element ${a} not found`);t.colors&&(e={...e,...t.colors});const o={target:a,colors:e,availableLangs:i.availableLangs,lang:t.lang||i.lang,messages:i.messages,showMessages:t.showMessages||i.showMessages,buttonType:t.buttonType||i.buttonType,buttonWidth:t.buttonWidth||i.buttonWidth,buttonHeight:t.buttonHeight||i.buttonHeight,className:t.className||i.className};t.lang&&o.availableLangs.includes(t.lang)&&(o.messages=u.en||u.en),t.messages&&(o.messages=Object.assign(o.messages,t.messages)),this.options=o,this.target=this.options.target,this.className=this.options.className,this.init()}init(){this.injectStyles(),this.renderTemplate()}send(t){!this.ws||(typeof t=="string"?this.ws.send(t):this.ws.send(JSON.stringify(t)))}dtmf(t){this.send({dtmf:`${this.sessionId}|${t}`})}startWebRTC(){this.pc=new this.peerConnection(this.ice),this.pc&&(this.pc.addEventListener("negotiationneeded",()=>{!this.pc||this.pc.createOffer().then(t=>{var e;return(e=this.pc)==null?void 0:e.setLocalDescription(t)}).then(()=>{var t;console.log(5551),this.send((t=this.pc)==null?void 0:t.localDescription)}).catch(function(t){console.log(t)})}),this.pc.addEventListener("track",t=>{this.audioPlayer&&(this.audioPlayer.srcObject=t.streams[0])}),navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(t=>{this.localStream=t,t.getTracks().forEach(e=>{var i;(i=this.pc)==null||i.addTrack(e,t)})}).catch(function(t){console.log(t)}))}stopWebRTC(){var t;this.pc&&(this.send({webrtc:"close"}),this.pc.onnegotiationneeded=null,this.pc.ontrack=null,this.audioPlayer&&this.audioPlayer.srcObject.getTracks().forEach(function(e){e.stop()}),(t=this.localStream)==null||t.getTracks().forEach(function(e){e.stop()}),this.pc.close(),this.pc=null),this.sessionId=0,this.busy=0}stopCall(){this.sessionId=0,this.send({info:"bye",msg_values:{line:"1"}}),this.stopWebRTC(),this.closeWS()}closeWS(){this.ws&&(this.ws.close(),this.ws=null)}connect(){this.ws=new WebSocket(this.server),this.setStage("calling"),this.ws.addEventListener("open",()=>{this.send({connect:{login:this.login,password:"aksdalksdnsk",phone_number:this.login,ver:"8"}}),this.isConnected=!0,setTimeout(()=>{this.send({invite:"sip:web@1",phone_num:"web",alt_phone:this.dnis})},300)}),this.ws.addEventListener("close",()=>{this.isConnected=!1,this.setStage("end")}),this.ws.addEventListener("message",t=>{this.isConnected=!0,this.onMessage(t.data)}),this.ws.addEventListener("error",()=>{this.isConnected=!1,this.setStage("end")})}onMessage(t){var i;const e=JSON.parse(t);console.log(t),e.msg_type==="ping"&&(console.log(5552),this.send({pong:"pong"})),e.msg_type==="call_session"&&(this.sessionId=e.msg_values.session,console.log(1),this.timer=0,this.setStage("talking")),e.msg_type==="route"&&(console.log(2),this.setStage("calling")),e.msg_type==="callme"&&(console.log(3),this.startWebRTC()),e.msg_type==="byed"&&(console.log(4),this.setStage("end"),this.busy=0,this.sessionId=0,this.stopWebRTC(),this.closeWS()),e.msg_type==="sdp"&&(console.log(5),(i=this.pc)==null||i.setRemoteDescription(new this.sessionDescription(e.msg_values)))}check(){if(typeof WebSocket!="function"){alert(this.options.messages.unsupprted);return}const t=navigator;if(t.getUserMedia_=t.mediaDevices.getUserMedia,typeof t.getUserMedia_!="function"){alert(this.options.messages.unsupprted);return}if(this.peerConnection=window.RTCPeerConnection,typeof this.peerConnection!="function"){alert(this.options.messages.unsupprted);return}if(this.sessionDescription=window.RTCSessionDescription,typeof this.sessionDescription!="function"){alert(this.options.messages.unsupprted);return}this.isSupported=!0,navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(()=>{this.isPermitted=!0,this.connect()}).catch(e=>{console.log(e),this.isPermitted=!1,alert("Microphone not detected or access denied")})}action(){console.log("actio",8888888),this.stage==="call"&&this.check(),this.stage==="talking"&&this.stopCall(),this.stage==="call"&&this.stopCall(),this.stage==="end"&&this.setStage("call")}destroy(){console.log("000000"),this.target.removeEventListener("click",this.clickListener),this.stopCall(),this.destroyStyles()}destroyStyles(){this.target&&(this.target.classList.remove(this.className),this.target.classList.remove(`${this.className}--stage-${this.stage}`),this.target.classList.remove(`${this.className}--type-${this.options.buttonType}`),this.target.style.height="",this.options.buttonType===d.Floating&&(this.target.style.width=""),this.target.innerHTML=""),this.stylesElement&&this.stylesElement.parentElement&&this.stylesElement.parentElement.removeChild(this.stylesElement)}objectToCSSVars(t){let e="";for(const[i,a]of Object.entries(t))e+=`--web-call-${i}:${a};`;return`:root{${e}}`}injectStyles(){try{this.stylesElement=document.createElement("style"),this.stylesElement.innerText=this.objectToCSSVars({...this.cssVars,...this.options.colors})+m,document.head.appendChild(this.stylesElement)}catch(t){console.error("style injection error",t)}}setStage(t){const e=this.options.className,i=this.options.target;for(const a of this.stageList)i.classList.remove(`${e}--stage-${a}`);this.stage=t,i.classList.add(`${e}--stage-${t}`),this.target.classList.remove(`${this.className}--show-keyboard`)}renderKeyboard(){let t="";const e=[1,2,3,4,5,6,7,8,9,0];for(const i of e)t+=`
            <div class="${this.className}__keyboard-col">
                <div class="${this.className}__keyboard-button">
                    ${i}
                </div>
            </div>`;return t}renderTemplate(){this.target.classList.add(this.className),this.target.classList.add(`${this.className}--stage-${this.stage}`),this.target.classList.add(`${this.className}--type-${this.options.buttonType}`),this.target.style.height=`${this.options.buttonHeight}px`,this.options.buttonType===d.Floating&&(this.target.style.width=`${this.options.buttonHeight}px`);const t=`
        <audio class="${this.className}__audio-player" volume='1' autoplay="autoplay"></audio>
        <div class="${this.className}__keyboard">
            <div class="${this.className}__keyboard-row">
                ${this.renderKeyboard()}
            </div>
        </div>
        <div class="${this.className}__stages">
            <div class="${this.className}__stage ${this.className}__stage--call">
                <div class="${this.className}__icon">${h("call")}</div>
                <div class="${this.className}__text">${this.options.messages.call}</div> 
            </div>
            <div class="${this.className}__stage ${this.className}__stage--calling">
                <div class="${this.className}__icon">${h("calling")}</div>
                <div class="${this.className}__text">${this.options.messages.calling}</div> 
            </div>
            <div class="${this.className}__stage ${this.className}__stage--talking">

                <div class="${this.className}__icon ${this.className}__icon--talking">${h("talking")}</div>
        
                <div class="${this.className}__text ${this.className}__timer">00:00</div>

            <div class="${this.className}__keyboard-toggle">${h("keyboard")}</div>
            </div>
            <div class="${this.className}__stage ${this.className}__stage--end">
                <div class="${this.className}__icon">${h("end")}</div>
                <div class="${this.className}__text">${this.options.messages.end}</div>
            </div>
        </div>`;this.target.innerHTML=t;const e=this.target.querySelector(`.${this.className}__timer`);e&&setInterval(()=>{this.timer++,e.innerHTML=this.getTimerSring(this.timer)},1e3);const i=this.target.querySelector(`.${this.className}__audio-player`);i&&(this.audioPlayer=i);const a=this.target.querySelector(`.${this.className}__keyboard`);a&&a.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation()});const o=this.target.querySelector(`.${this.className}__keyboard-toggle`);o&&o.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),this.target.classList.toggle(`${this.className}--show-keyboard`)}),this.clickListener=this.action.bind(this),this.target.addEventListener("click",this.clickListener)}getTimerSring(t){const e=Math.floor(t/3600),i=Math.floor(t/60)%60,a=t%60;return[e,i,a].map(o=>o<10?"0"+o:o).filter((o,g)=>o!=="00"||g>0).join(":")}async getPermission(){return this.permissions=!0,await new Promise(e=>{navigator.mediaDevices.getUserMedia({video:!1,audio:!0}).then(()=>{e(!0)}).catch(i=>{console.log(i)})})}}function k(n){return new v(n)}typeof window=="object"&&(window.okiToki={createWebCall:k})})();
